# RAG 기반 산업군 추천 및 분석 시스템 기능 명세서

## 1. 시스템 개요

본 시스템은 Azure Cognitive Search와 Azure OpenAI를 활용한 RAG(Retrieval-Augmented Generation) 기반 산업 분석 플랫폼입니다. 사용자의 관심 키워드를 기반으로 문서 검색, 산업군 추천, 대화형 분석, 최종 보고서 생성까지 전 과정을 자동화합니다.

---

## 2. 핵심 기술 스택

### 2.1 백엔드 인프라
- **Azure Cognitive Search**: 벡터 검색 및 RAG 문서 검색
- **Azure OpenAI**: GPT 모델 기반 자연어 처리 및 보고서 생성
- **Python 3.x**: 백엔드 로직 구현

### 2.2 프론트엔드
- **Streamlit**: 웹 기반 대화형 UI 프레임워크
- **세션 상태 관리**: 단계별 데이터 유지 및 워크플로우 제어

---

## 3. 주요 기능

### 3.1 키워드 기반 RAG 검색
**기능 설명**
- 사용자가 입력한 키워드로 Azure Cognitive Search에서 관련 문서 검색
- 상위 5개 결과를 추출하여 화면에 표시

**처리 흐름**
1. 키워드 입력 → `st.text_input()`
2. Azure Search API 호출 → `search_client.search(keyword, top=5)`
3. 검색 결과 추출 → title, chunk 필드
4. 세션 상태 저장 → `st.session_state.search_results`

**출력 형식**
- 문서 제목 (굵게 표시)
- 문서 내용 미리보기 (최대 300자)

---

### 3.2 GPT 기반 산업군 추천
**기능 설명**
- 검색된 문서를 GPT에 전달하여 유망 산업군 5개 추천
- 각 산업군에 대한 간단한 설명 포함

**프롬프트 구조**
```
다음은 '{키워드}' 키워드에 대해 검색된 문서 내용입니다:
{검색된 문서 전체}

이 정보를 바탕으로 관련된 유망 산업군을 5개 추천해 주세요.
각 산업군은 간단한 설명과 함께 제시해 주세요.
```

**처리 로직**
- GPT 응답을 줄 단위로 파싱
- 불릿 포인트(-, •) 제거 및 정규화
- `recommendation_list`에 저장하여 드롭다운 선택지로 활용

---

### 3.3 산업군 선택 및 대화형 Q&A
**기능 설명**
- 추천된 산업군 중 하나를 선택
- 선택한 산업군에 대해 GPT와 대화형 질의응답 수행

**질의응답 시스템**
- **시스템 프롬프트**: "당신은 '{산업군}' 산업군의 시장 분석 전문가입니다."
- **대화 컨텍스트 유지**: 이전 질문-답변 히스토리를 messages 배열로 전달
- **실시간 답변**: 질문 입력 후 "질문하기" 버튼 클릭 시 즉시 응답

**대화 기록 관리**
- `chat_history`에 (질문, 답변) 튜플 형태로 저장
- 최신순으로 화면에 표시 (Q1, A1, Q2, A2...)

---

### 3.4 누적 질의응답 표시
**기능 설명**
- 모든 질의응답 내역을 시간 역순으로 표시
- 보고서 작성 시 전체 대화 컨텍스트로 활용

**표시 형식**
```
Q3: [최신 질문]
A3: [최신 답변]

Q2: [두 번째 질문]
A2: [두 번째 답변]

Q1: [첫 번째 질문]
A1: [첫 번째 답변]
```

---

### 3.5 GPT 보고서 작성 (단계별)
**기능 설명**
- 대화 내용을 기반으로 종합 사업 제안 보고서 생성
- 긴 보고서를 여러 청크로 나눠 작성 가능

**보고서 구조**
1. **산업 개요 및 시장 동향**
2. **주요 경쟁사 및 비교 분석**
3. **진입 전략 및 기회 요인**
4. **사업화 제안 요약**

**처리 흐름**
1. "보고서 작성 시작" 버튼 클릭
   - 전체 대화 히스토리를 GPT에 전달
   - 첫 번째 보고서 청크 생성
   
2. "계속 작성" 버튼 (선택적)
   - 이전 청크들을 컨텍스트로 전달
   - 추가 청크 생성 및 누적
   
3. "보고서 완료" 버튼
   - 모든 청크를 병합하여 최종 보고서 생성
   - 화면 상태 초기화

---

### 3.6 최종 보고서 화면
**기능 설명**
- 보고서 완료 시 전체 UI 초기화
- 최종 보고서만 깔끔하게 표시
- 파일 생성 기능 제공 (향후 구현 예정)

**화면 구성**
- 제목: "📄 최종 GPT 보고서"
- 본문: 병합된 전체 보고서 내용 (Markdown 형식)
- 버튼: "📁 최종 보고서 파일 생성" (PDF, DOCX 등)

---

## 4. 세션 상태 관리

### 4.1 상태 변수 목록

| 변수명 | 타입 | 설명 |
|--------|------|------|
| `keyword` | str | 사용자 입력 키워드 |
| `search_results` | list | RAG 검색 결과 (문서 리스트) |
| `recommendations_raw` | str | GPT 추천 원본 텍스트 |
| `recommendation_list` | list | 파싱된 산업군 리스트 |
| `selected_industry` | str | 사용자 선택 산업군 |
| `chat_history` | list | 질의응답 히스토리 [(Q, A), ...] |
| `report_chunks` | list | 보고서 청크 리스트 |
| `report_ready` | bool | 보고서 작성 완료 여부 |
| `report_final` | str | 최종 병합 보고서 |
| `report_completed` | bool | 최종 화면 전환 플래그 |

### 4.2 상태 초기화 시점
- **전체 초기화**: "🔄 전체 초기화" 버튼 클릭
- **보고서 완료 시 부분 초기화**: keyword, search_results 등 작업 데이터만 초기화

---

## 5. 워크플로우

```
1. 키워드 입력
   ↓
2. RAG 검색 (Azure Search)
   ↓
3. GPT 산업군 추천 (5개)
   ↓
4. 산업군 선택
   ↓
5. GPT 질의응답 (반복 가능)
   ↓
6. 보고서 작성 시작
   ↓
7. 보고서 계속 작성 (선택적, 반복 가능)
   ↓
8. 보고서 완료
   ↓
9. 최종 보고서 화면
   ↓
10. 파일 생성 (향후 구현)
```

---

## 6. API 호출 구조

### 6.1 ask_openai() 함수
**파라미터**
- `prompt` (str, optional): 단일 프롬프트 문자열
- `messages` (list, optional): 대화 히스토리 배열

**반환값**
- GPT 응답 텍스트 (str)

**GPT 설정**
- `temperature`: 0.7 (창의성과 일관성 균형)
- `max_tokens`: 1500 (충분한 응답 길이)
- `api_version`: "2024-12-01-preview"

---

## 7. 환경 변수 설정

```bash
AZURE_SEARCH_ENDPOINT=https://your-search.search.windows.net
AZURE_SEARCH_KEY=your-search-key
AZURE_SEARCH_INDEX=your-index-name
AZURE_OPENAI_KEY=your-openai-key
AZURE_OPENAI_DEPLOYMENT=your-gpt-deployment
AZURE_OPENAI_ENDPOINT=https://your-openai.openai.azure.com/
```

---

## 8. 주요 특징 및 장점

### 8.1 RAG 기반 정확성
- 실제 문서 검색 결과를 기반으로 산업군 추천
- 환각(hallucination) 최소화

### 8.2 대화형 분석
- 반복적인 질의응답을 통한 심층 분석 가능
- 컨텍스트 유지로 일관된 답변 제공

### 8.3 단계별 보고서 생성
- 긴 보고서를 청크 단위로 생성하여 토큰 제한 회피
- 사용자가 원하는 만큼 내용 확장 가능

### 8.4 깔끔한 UX
- 보고서 완료 시 작업 화면 숨김
- 최종 결과물에 집중할 수 있는 인터페이스

---

## 9. 향후 개선 방향

### 9.1 에러 처리
- API 호출 실패 시 예외 처리 추가
- 사용자 친화적 오류 메시지 표시

### 9.2 파일 출력 기능
- PDF 변환 (reportlab, weasyprint)
- DOCX 생성 (python-docx)
- Excel 차트 포함 (openpyxl)

### 9.3 고급 RAG 기능
- Hybrid Search (키워드 + 벡터)
- Re-ranking 적용
- 문서 출처 표시 (citation)

### 9.4 사용자 경험 개선
- 로딩 인디케이터 추가
- 진행 상태 바 표시
- 보고서 템플릿 선택 기능

---

## 10. 결론

본 시스템은 RAG 기술과 대화형 AI를 결합하여 사용자가 키워드 하나로 종합적인 산업 분석 보고서를 생성할 수 있도록 설계되었습니다. 직관적인 UI와 단계별 워크플로우로 전문 지식 없이도 고품질 분석 자료를 생성할 수 있습니다.